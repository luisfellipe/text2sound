<!doctype html>
<html lang="pt-br">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="#">
    <link rel="stylesheet" type="text/css" href="style.css">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <!--Jquery-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" 
    integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg=="
    crossorigin="anonymous"></script>
  
    <title>Text2Sound</title>
  </head>

  <body onload="getComments();">
  </br></br>
    <div class="container">
      <div class="row">

        <div class="col-md-6">
          <div id="comment_area">
            <form id="submit" >
              <div><!--Inserir Comentario-->
                <label id="lbcomment" for="comment"><b>Coment치rio</b></label></br>
                <textarea
                id="comment_text" 
                name="comment_text" 
                maxlength="250"
                placeholder="Digite seu coment치rio aqui! m치ximo de 250 caracteres.">   
              </textarea>
              </div><!--Fim Inserir Comentario-->
               <div>
                <button type="submit" id="btn-cadastrar">cadastrar</button>
              </div>
            </form>
          </div>  <!--End comment_area-->
        </div>  <!--End column-->

        <!--Lista de comentarios-->
          <div  class="col-md-6">
            <div id="comments">
                <label id="title"><b>Coment치rios</b></label>
                <div id="list_comments" class="container">

                </div>  
            </div> <!--Fim list_comments--> 
          </div>  <!--Fim column-->

      </div> <!--Fim row-->
    </div> <!--Fim container-->
  
    <script type="text/javascript">

      //set cursor to beginning
      var textarea = document.getElementById('comment_text');
      textarea.value = '';

      /**
       * triggers an event by clicking the 'value="cadastrar"' button
       */ 
      $(document).ready(function() {// jquery 
        $("#btn-cadastrar").on("click",function(event) {
          event.preventDefault();
          var comment = document.getElementById("comment_text").value;
          // set and get comments after
          setComment(comment);
          getComments();
        });
      });//end jquery

      /**
       * set comment to server
       */
      function setComment(comment){
        comment = comment.trim();
        if(comment == '') return;
        var data = {"comment_text": comment};
        var xhttp = new XMLHttpRequest();
        xhttp.open("POST", "/post", true);
        xhttp.timeout = 10000;
        xhttp.dataType = "json";
        xhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        xhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
              getComments();
              console.log("OK! status "+ this.status);
          }
        };
        xhttp.send(JSON.stringify(data));
      }// end setComment


      /**
       * 
       * get all comments from server
       */ 
      function getComments(){ 
        var xhttp = new XMLHttpRequest();
        xhttp.open("GET", "/getcomments", true);
        xhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            var html = makeHtml(this.responseText);
            $("#list_comments").append(html);
          }
        };
      xhttp.send();
      }//end getComments

      /**
       * 
       * render a list of comments on the page
       */  
      function makeHtml(comments){
        console.log(comments);
        comments = JSON.parse(comments);
        var len = comments.length;
        $("#list_comments").empty()
      var html = "<br>";
       for(var i = 0; i < len; i++){
          var comment = comments[i].comment_text;
          var id = "comment"+ comments[i].id;
          var tooltip = "data-toggle=\"tooltip\" data-placement=\"left\" title=\"click e espere um momento para o arquivo ser gerado e click novamente\"";
          html += 
            "<div class=\"row\">"+
              "<div class=\"col-10\">"+
                "<span id=\""+id+ "\">"+comment+"</span>"+
              "</div>"+
              "<div class=\"col-2\">"+
                "<input "+tooltip+" onclick=\"saySomething("+id+");\" value=\"Ouvir\" class=\"btn-ouvir\"  type=\"submit\">"+   
              "</div>"+
            "</div></br>";
        }
        return html;
      }//end  makeHtml

      /**
       * no words needed
       */
      function saySomething(comment){
        comment = comment.innerHTML;   
        var data = {"text":comment};
        var xhttp = new XMLHttpRequest();
        xhttp.open("POST", "/toaudio", true);
        xhttp.timeout = 10000;
        xhttp.dataType = "json";
        xhttp.responseType = "text";
        xhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        xhttp.onreadystatechange = function() {
          if (this.readyState == xhttp.DONE && this.status == 200) {
            console.log("Ok! "+ this.status);
          }
        };
        xhttp.send(JSON.stringify(data));
      }//end saySomething
    </script>

  </body>
</html>